name: Build check for RC merge 

on:
  pull_request:
    branches:
      - 'rs_lambda_*'  # Adjust this pattern to match your rc_ branch naming convention
  
jobs: 
  Check-for-Build:
    runs-on: ubuntu-latest
    permissions:
      # This permission is required for requesting the web token without which you can't access the aws 
      id-token: write 
      contents: read
      # this permission should be set to be able get commits data by curl request
      pull-requests: read
    steps:

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Check for rebase 
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          echo "BASE_BRANCH: $BASE_BRANCH"
      
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD_SHA: $HEAD_SHA"

          BASE_SHA=$(git rev-parse remotes/origin/$BASE_BRANCH)
          echo "BASE_SHA: $BASE_SHA"

          COMMON_ANCESTOR=$(git merge-base $HEAD_SHA $BASE_SHA)
          echo "COMMON_ANCESTOR: $COMMON_ANCESTOR"

          if [ "$COMMON_ANCESTOR" = "$BASE_SHA" ] ; then
            echo "Branch is up to date. No rebase needed."
          else
            echo "Branch is not up to date. Please rebase before merging."
            exit 1
          fi  

      - name: Check Commit Message is empty or not
        run: |
          # Retrieve the saved commit message from the environment variables
          COMMIT_MESSAGE="$(git show -s --format=%s)"

          # Check if the commit message is empty
          if [[ -z "$COMMIT_MESSAGE" ]]; then
            echo "Commit message is empty. Cannot Merge."
            exit 1  # Terminate the workflow with a status code of 1
          else 
            echo "Commit message present"
          fi
          
      - name: Check head git commit message
        run: |
          # echo "$(git show -s --format=%s)" 
          # Run the git show command and capture its output in an environment variable
          COMMIT_MESSAGE="$(git show -s --format=%s)"
          
          # Check if the commit message contains "CodeBuild"
          if [[ "$COMMIT_MESSAGE" == *CodeBuild* ]]; then
            echo "Commit message contains 'CodeBuild'. Proceeding with workflow."
          else
            echo "Commit message does not contain 'CodeBuild' which is required to start CodeBuild. Exiting workflow."
            exit 1  # Terminate the workflow with a non-zero status code
          fi

          
      - name: LOGIN TO AWS Account
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::270867340686:role/CodeBuildFromGitHub
          aws-region: us-east-1

      - name: Run Build
        id: start-build
        run: |
          # Get the latest commit SHA
          LATEST_SHA=$(git rev-parse HEAD)

          # Get build id from json output generated by the aws command 
          BUILD_ID=$(aws codebuild start-build --project mimas-build --source-version $LATEST_SHA | jq -r '.build.id')
          
          while true; do

            # Getting current status and phases of the build
            BUILD_STATUS=$(aws codebuild batch-get-builds --ids $BUILD_ID | jq -r '.builds[0].buildStatus')
            BUILD_PHASE=$(aws codebuild batch-get-builds --ids $BUILD_ID | jq -r '.builds[0].currentPhase')
            echo "Current build status: $BUILD_STATUS"
            echo "Current build phase: $BUILD_PHASE"

            if [[ "$BUILD_STATUS" == "SUCCEEDED" ]]; then
              break
            elif [[ "$BUILD_STATUS" == "FAILED" || "$BUILD_STATUS" == "STOPPED" ]]; then
              echo "Build failed"
              exit 1
            fi

            sleep 45
          done
